Процедура ПечатьРаспределниеНаПродукцию(ТабДок, Ссылка) Экспорт
	//{{_КОНСТРУКТОР_ПЕЧАТИ(ПечатьРаспределниеНаПродукцию)
	
	//Считывание макета
	Макет = Документы.РаспределениеПрочихЗатрат.ПолучитьМакет("ПечатьРаспределниеНаПродукцию");
		Запрос = Новый Запрос;
		ЗапросПерваяВыборка(Запрос);
			
		Запрос.Параметры.Вставить("Ссылка", Ссылка);	
		Выборка = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "Ссылка");
	
			Запрос = Новый Запрос;
			ЗапросВтораяВыборка(Запрос);

			Запрос.Параметры.Вставить("Ссылка", Ссылка);
			ВыборкаНовая = Запрос.Выполнить();

				ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
				Шапка = Макет.ПолучитьОбласть("Шапка");
				ТабДок.Очистить();
				ВставлятьРазделительСтраниц = Ложь;
	
				Пока Выборка.Следующий() Цикл
		
					Если ВставлятьРазделительСтраниц Тогда
						ТабДок.ВывестиГоризонтальныйРазделительСтраниц();
					КонецЕсли;

					ТабДок.Вывести(ОбластьЗаголовок);

					Шапка.Параметры.Заполнить(Выборка);
					ТабДок.Вывести(Шапка, Выборка.Уровень());
					
					
					// СуммыКРаспределению
					Область = Макет.ПолучитьОбласть("СуммыКРаспределениюШапка");
				
					ТабДок.Вывести(Область);
					ОбластьСуммыКРаспределению = Макет.ПолучитьОбласть("СуммыКРаспределению");
					ВыборкаСуммыКРаспределению = ВыборкаНовая.Выбрать();
					
						//Для итогов
						СуммаИтогоСуммы = 0;
							Пока ВыборкаСуммыКРаспределению.Следующий() Цикл
								ОбластьСуммыКРаспределению.Параметры.Заполнить(ВыборкаСуммыКРаспределению);
								СуммаИтогоСуммы = СуммаИтогоСуммы + ВыборкаСуммыКРаспределению.Сумма;
								ТабДок.Вывести(ОбластьСуммыКРаспределению);
							КонецЦикла;
						
						ОбластьИтогиСуммы = Макет.ПолучитьОбласть("СуммыКРаспределениюИтоги");
							СтруктураИтогиСуммы = Новый Структура("СуммаИтогоСуммы", СуммаИтогоСуммы);
							ОбластьИтогиСуммы.Параметры.Заполнить(СтруктураИтогиСуммы);
						ТабДок.Вывести(ОбластьИтогиСуммы);

						ОбластьЗатратыНаПродукциюШапка = Макет.ПолучитьОбласть("ЗатратыНаПродукциюШапка");
						ТабДок.Вывести(ОбластьЗатратыНаПродукциюШапка);
						ВыборкаЗатратыНаПродукцию = Выборка.Выбрать(ОбходРезультатаЗапроса.Прямой);
						
						//Для итогов
						СуммаИтогоЗатраты = 0;
							Пока ВыборкаЗатратыНаПродукцию.Следующий() Цикл
								ОбластьЗатратыНаПродукцию = Макет.ПолучитьОбласть("ЗатратыНаПродукцию");
								ОбластьЗатратыНаПродукцию.Параметры.Заполнить(ВыборкаЗатратыНаПродукцию);
								СуммаИтогоЗатраты = СуммаИтогоЗатраты + ВыборкаСуммыКРаспределению.Сумма;
								ТабДок.Вывести(ОбластьЗатратыНаПродукцию, ВыборкаЗатратыНаПродукцию.Уровень());
							КонецЦикла;
						
						ОбластьИтогиСуммы = Макет.ПолучитьОбласть("ЗатратыКРаспределениюИтоги");
							СтруктураИтогиСуммы = Новый Структура("СуммаИтогоЗатраты", СуммаИтогоЗатраты);
							ОбластьИтогиСуммы.Параметры.Заполнить(СтруктураИтогиСуммы);
						ТабДок.Вывести(ОбластьИтогиСуммы);
						
						ВставлятьРазделительСтраниц = Истина;		
					КонецЦикла;
	//}}
КонецПроцедуры

Процедура ЗапросПерваяВыборка(Запрос)
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	РаспределениеПрочихЗатрат.Дата,
	|	РаспределениеПрочихЗатрат.Номер,
	|	РаспределениеПрочихЗатрат.Организация,
	|	ТЧЗатратыНаПродукцию.Спецификация,
	|	ТЧЗатратыНаПродукцию.СтатьяЗатрат,
	|	ТЧЗатратыНаПродукцию.Сумма КАК Сумма,
	|	ТЧЗатратыНаПродукцию.СчетЗатрат,
	|	РаспределениеПрочихЗатрат.Ссылка КАК Ссылка,
	|	РаспределениеПрочихЗатрат.СхемаРаспределения,
	|	РаспределениеПрочихЗатрат.СхемаРаспределения.СчетЗатрат,
	|	РаспределениеПрочихЗатрат.СуммыКРаспределению.(
	|		Субконто1,
	|		Субконто2,
	|		Субконто3,
	|		СУММА(Сумма),
	|		СчетЗатрат
	|	)
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат.ЗатратыНаПродукцию КАК ТЧЗатратыНаПродукцию
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК РаспределениеПрочихЗатрат
	|		ПО ТЧЗатратыНаПродукцию.Ссылка = РаспределениеПрочихЗатрат.Ссылка
	|ГДЕ
	|	РаспределениеПрочихЗатрат.Ссылка В(&Ссылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	РаспределениеПрочихЗатрат.СуммыКРаспределению.(СчетЗатрат,
	|	Субконто1,
	|	Субконто2,
	|	Субконто3)
	|ИТОГИ
	|	СУММА(Сумма)
	|ПО
	|	ОБЩИЕ,
	|	Ссылка";	
КонецПроцедуры

Процедура ЗапросВтораяВыборка(Запрос)
	Запрос.Текст =
			"ВЫБРАТЬ
			|	РаспределениеПрочихЗатратСуммыКРаспределению.Ссылка,
			|	РаспределениеПрочихЗатратСуммыКРаспределению.СчетЗатрат,
			|	РаспределениеПрочихЗатратСуммыКРаспределению.Субконто1,
			|	РаспределениеПрочихЗатратСуммыКРаспределению.Субконто2,
			|	РаспределениеПрочихЗатратСуммыКРаспределению.Субконто3,
			|	СУММА(РаспределениеПрочихЗатратСуммыКРаспределению.Сумма) КАК Сумма
			|ИЗ
			|	Документ.РаспределениеПрочихЗатрат.СуммыКРаспределению КАК РаспределениеПрочихЗатратСуммыКРаспределению
			|ГДЕ
			|	РаспределениеПрочихЗатратСуммыКРаспределению.Ссылка В(&Ссылка)
			|
			|СГРУППИРОВАТЬ ПО
			|	РаспределениеПрочихЗатратСуммыКРаспределению.Ссылка,
			|	РаспределениеПрочихЗатратСуммыКРаспределению.СчетЗатрат,
			|	РаспределениеПрочихЗатратСуммыКРаспределению.Субконто1,
			|	РаспределениеПрочихЗатратСуммыКРаспределению.Субконто3,
			|	РаспределениеПрочихЗатратСуммыКРаспределению.Субконто2";
КонецПроцедуры